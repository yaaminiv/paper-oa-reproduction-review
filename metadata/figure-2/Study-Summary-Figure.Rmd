---
title: "Study Summary Figure"
author: "Yaamini Venkataraman"
date: "11/25/2019"
output: github_document
---

In this script, I will create a figure that summarizes the findings from studies used to review the impact of ocean acidification on marine invertebrate reproductive processes before embryonic development. The three individual figures will be arranged into a multipanel plot in InDesign.

# Set up R Markdown Document 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/yaaminivenkataraman/Documents/paper-oa-reproduction-review/metadata/figure-2/") #Set root directory
```

# Install packages

```{r}
#Install packages
#install.packages("RColorBrewer") #Create color palettes
#install.packages("dichromat") #Color-blind simulation
#install.packages("tidyverse") #Data manipulation
#install.packages("reshape2") #Melt and cast data frames
#install.packages("ggplot2") #Plotting
#install.packages("scatterpie") #Pie chart map
```

```{r}
#Load packages
require(RColorBrewer)
require(dichromat)
require(tidyverse)
require(scatterpie)
```

#Session information

```{r}
sessionInfo()
```

# Import and format metadata

```{r}
cnidarianMetadata <- read.csv("../cnidarians_metadata.csv", header = TRUE) #Import cnidarian metadata
cnidarianMetadata <- cnidarianMetadata %>% 
  select(., Reproductive.Stage, Effect..Y.N.., Year, Collection.Location..Marine.Ecoregion, DOI) %>% 
  rename(., category = Reproductive.Stage, effect = Effect..Y.N.., year = Year, collectionLocation = Collection.Location..Marine.Ecoregion) %>% 
  mutate(taxa = rep("cnidarian", times = length(year))) #Subset necessary columns, change column names, and add new column
head(cnidarianMetadata) #Confirm formatting
```

```{r}
crustaceanMetadata <- read.csv("../crustaceans_metadata.csv", header = TRUE) #Import crustacean metadata
crustaceanMetadata <- crustaceanMetadata %>% 
  select(., Reproductive.Stage, Effect..Y.N.., Year, Collection.Location..Marine.Ecoregion, DOI) %>% 
  rename(., category = Reproductive.Stage, effect = Effect..Y.N.., year = Year, collectionLocation = Collection.Location..Marine.Ecoregion) %>% 
  mutate(taxa = rep("crustacean", times = length(year))) #Subset necessary columns, change column names, and add new column
head(crustaceanMetadata) #Confirm formatting
```

```{r}
echinodermMetadata <- read.csv("../echinoderms_metadata.csv", header = TRUE) #Import echinoderm metadata
echinodermMetadata <- echinodermMetadata %>% 
  select(., Reproductive.Stage, Effect..Y.N.., Year, Collection.Location..Marine.Ecoregion, DOI) %>% 
  rename(., category = Reproductive.Stage, effect = Effect..Y.N.., year = Year, collectionLocation = Collection.Location..Marine.Ecoregion) %>% 
  mutate(taxa = rep("echinoderm", times = length(year))) #Subset necessary columns, change column names, and add new column
head(echinodermMetadata) #Confirm formatting
```

```{r}
molluscMetadata <- read.csv("../molluscs_metadata.csv", header = TRUE) #Import mollusc metadata
molluscMetadata <- molluscMetadata %>% 
  select(., Reproductive.Stage, Effect..Y.N.., Year, Collection.Location..Marine.Ecoregion, DOI) %>% 
  rename(., category = Reproductive.Stage, effect = Effect..Y.N.., year = Year, collectionLocation = Collection.Location..Marine.Ecoregion) %>% 
  mutate(taxa = rep("mollusc", times = length(year))) #Subset necessary columns, change column names, and add new column
head(molluscMetadata) #Confirm formatting
```

```{r}
allMetadata <- rbind(cnidarianMetadata, crustaceanMetadata, echinodermMetadata, molluscMetadata) #Combine all metadata information
head(allMetadata) #Confirm formatting
```

# Reproduction category

## Format data

```{r}
reproductionCatMetadata <- allMetadata %>% select(., category, effect, taxa) #Keep columns necessary for reproduction category
head(reproductionCatMetadata) #Confirm formatting
```

```{r}
#Group dataframe by taxa, category, and effect, count the number of studies in each group, pivot the dataframe so taxa are columns, replace NA with 0, then rearrange rows based on category

findingSummary <- reproductionCatMetadata %>%
  group_by(., taxa, category, effect) %>%
  summarise(count = n()) %>%
  pivot_wider(., names_from = taxa, values_from = count) %>%
  replace(is.na(.), 0) %>%
  arrange(., category)
head(findingSummary) #Confirm formatting
```

```{r}
write.csv(findingSummary, "../Reproduction-Category.csv", quote = FALSE, row.names = FALSE) #Save dataframe
```

## Create color scheme

```{r}
barplotColors <- c("grey90", "grey10") #Create a BW palette with 2 colors to represent effect and no effect of OA on reproductive processes
```

## Create multipanel plot

```{r}
pdf("Reproduction-Category-Summary-Barplots.pdf", height = 8.5, width = 11)
par(mfrow = c(3,2), oma = c(0, 5, 2, 0), mar = c(5, 5, 0, 0))

#Sex determination
barplot(t(t(findingSummary[9:10, 3:6])), 
        axes = FALSE, axisnames = FALSE,
        col = barplotColors) #Create a stacked barplot using colors in barplotColors. Do not plot any axes and increase font size of x-axis labels
axis(side = 2, at = c(0,5), las = 2, col = "grey80", cex.axis = 3) #Add y-axis
mtext(side = 2, "Number of Findings", line = 2, cex = 2, outer = TRUE) #Add outer y-axis label
mtext(side = 3, " Sex Determination", adj = 0, line = -1, cex = 1.5) #Add category name
#mtext(side = 3, expression(italic("  ? studies")), adj = 0, line = -3, cex = 1.2) #Add total studies

legend(x = 0.05, y = 4, 
       legend = c("Effect", "No Effect"), cex = 2.3,
       pch = 22, pt.cex = 4.5,
        col = "black",
        pt.bg = rev(barplotColors),
       bty = "n") #Add legend

#Gametogenesis
barplot(t(t(findingSummary[5:6, 3:6])), 
        axes = FALSE, axisnames = FALSE,
        col = barplotColors) #Create a stacked barplot using colors in barplotColors. Do not plot any axes and increase font size of x-axis labels
axis(side = 2, at = c(0,24), las = 2, col = "grey80", cex.axis = 3) #Add y-axis
mtext(side = 3, " Gametogenesis", adj = 0, line = -1, cex = 1.5) #Add category name
#mtext(side = 3, expression(italic("  ? studies")), adj = 0, line = -3, cex = 1.2) #Add total studies

#Fecundity
barplot(t(t(findingSummary[1:2, 3:6])),  
        axes = FALSE, axisnames = FALSE,
        col = barplotColors) #Create a stacked barplot using colors in barplotColors. Do not plot any axes and increase font size of x-axis labels
axis(side = 2, at = c(0,40), las = 2, col = "grey80", cex.axis = 3) #Add y-axis
mtext(side = 3, " Fecundity", adj = 0, line = -1, cex = 1.5) #Add category name
#mtext(side = 3, expression(italic("  ? studies")), adj = 0, line = -3, cex = 1.2) #Add total studies

#Timing
barplot(t(t(findingSummary[11:12, 3:6])),  
        axes = FALSE, axisnames = FALSE,
        col = barplotColors) #Create a stacked barplot using colors in barplotColors. Do not plot any axes and increase font size of x-axis labels
axis(side = 2, at = c(0,4), las = 2, col = "grey80", cex.axis = 3) #Add y-axis
mtext(side = 3, " Timing", adj = 0, line = -1, cex = 1.5) #Add category name
#mtext(side = 3, expression(italic("  ? studies")), adj = 0, line = -3, cex = 1.2) #Add total studies

#Mating behavior
barplot(t(t(findingSummary[7:8, 3:6])),   
        axes = FALSE, 
        names.arg = c("N", "C", "E", "M"), cex.names = 2.5,
        col = barplotColors) #Create a stacked barplot using colors in barplotColors. Do not plot any axes and increase font size of x-axis labels
axis(side = 2, at = c(0,1), las = 2, col = "grey80", cex.axis = 3) #Add y-axis
mtext(side = 3, " Mating", adj = 0, line = -1, cex = 1.5) #Add category name
#mtext(side = 3, expression(italic("  ? studies")), adj = 0, line = -3, cex = 1.2) #Add total studies

#Fertilization
barplot(t(t(findingSummary[3:4, 3:6])),
        axes = FALSE, 
        names.arg = c("N", "C", "E", "M"), cex.names = 2.5,
        col = barplotColors) #Create a stacked barplot using colors in barplotColors. Do not plot any axes and increase font size of x-axis labels
axis(side = 2, at = c(0,66), las = 2, col = "grey80", cex.axis = 3) #Add y-axis
mtext(side = 3, " Fertilization", adj = 0, line = -1, cex = 1.5) #Add category name
#mtext(side = 3, expression(italic("  ? studies")), adj = 0, line = -3, cex = 1.2) #Add total studies

dev.off()
```

# Year published

## Format data

```{r}
yearMetadata <- allMetadata %>% 
  select(., taxa, year, DOI) %>%
  distinct(., DOI, .keep_all = TRUE) %>%
  select(., taxa, year) #Select taxa, year and DOI columns, keep rows with unique DOI (remove duplicates generated by reproduction category findings), and remove DOI column
head(yearMetadata) #Confirm formatting
```

```{r}
#Group yearMetadata by taxa and year, count studies per taxa/year, make taxa columns, replace NA with 0, reorganize by year, remove 1924, then add cumulative sums for each taxa and save as another column

yearPublished <- yearMetadata %>%
  group_by(., taxa, year) %>%
  summarise(count = n()) %>%
  pivot_wider(., names_from = taxa, values_from = count) %>%
  replace(is.na(.), 0) %>%
  arrange(., year) %>%
  slice(., -1) %>%
  mutate(., 
         totCnidarian = cumsum(cnidarian),
         totCrustacean = cumsum(crustacean),
         totEchinoderm = cumsum(echinoderm),
         totMollusc = cumsum(mollusc))
head(yearPublished) #Confirm formatting
```

```{r}
write.csv(yearPublished, "../Year-Published.csv", quote = FALSE, row.names = FALSE) #Save dataframe
```

## Create color scheme

```{r}
yearColors <- RColorBrewer::brewer.pal(4, "RdBu") #Create a red-blue palette with 4 colors to represent each taxa

#Add simulated color-blindness. Will need to change line type for addtional contrast
plot(yearPublished$totCnidarian, type = "l", col = dichromat(yearColors[1]), ylim = c(0,70), lty = 4, lwd = 3)
lines(yearPublished$totEchinoderm, col = dichromat(yearColors[2]), lwd = 3)
lines(yearPublished$totMollusc, col = dichromat(yearColors[3]), lty = 4, lwd = 3)
lines(yearPublished$totCrustacean, col = dichromat(yearColors[4]), lwd = 3)
```

## Create plot

```{r}
#pdf("Year-Published-Summary-Line-Plots.pdf", height = 4.25, width = 11)
par(mar = c(5, 6, 3, 1), oma = c(0, 1, 0, 0)) #Change margins

plot(yearPublished$totCnidarian, type = "l", ylim = c(0,70),
     col = yearColors[1], lwd = 3,
     xaxt = "n", yaxt = "n",
     xlab = "", ylab = "",
     xaxs = "i", yaxs = "i") #Plot a line graph with no axes or axis labels
lines(yearPublished$totEchinoderm, col = yearColors[3], lwd = 3) #Add echinoderm information
lines(yearPublished$totMollusc, col = yearColors[4], lwd = 3) #Add mollusc information
lines(yearPublished$totCrustacean, col = yearColors[2], lwd = 3) #Add crustacean information

#Remove black box around plot
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")
box(col = "white")

axis(side = 1, at = 1:16, labels = yearPublished$year, las = 2, col = "grey80", cex.axis = 2) #Add an x-axis with year information

axis(side = 2, at = seq(0, 70, 10), labels = seq(0, 70, 10), las = 2, col = "grey80", cex.axis = 2) #Add y-axis with paper count information
mtext("Cumulative Publications", side = 2, line = 4.5, cex = 2) #Add a y-axis label

legend("topleft",
       cex = 1.75,
       c("Cnidarian", "Crustacean", "Echinoderm", "Mollusc"),
       lty = rep(1, times = 4), lwd = 3,
       col = yearColors,
       bty = "n")

#dev.off()
```

# Location conducted

## Format data

```{r}
locationMetadata <- allMetadata %>% select(., taxa, collectionLocation) #Keep columns necessary for reproduction category
head(locationMetadata) #Confirm formatting
```

```{r}
#Group yearMetadata by taxa and year, count studies per taxa/year, make taxa columns, replace NA with 0, reorganize by collection location, remove NA collection locations, add numeric region information, latitude, and longitude information

locationData <- locationMetadata %>%
  group_by(., taxa, collectionLocation) %>%
  summarise(count = n()) %>%
  pivot_wider(., names_from = taxa, values_from = count) %>%
  replace(is.na(.), 0) %>%
  arrange(., collectionLocation) %>%
  filter(., collectionLocation != "N/A") %>%
  mutate(., 
         region = seq(1:length(locationData$collectionLocation)),
         latitude = c(80, 10, 0, -60, -50, 40, 40, -50, -40, 0, 0),
         longitude = c(20, 130, -180, 0, 150, -40, -160, -55, 20, -20, 77))
head(locationData) #Confirm formatting
```

```{r}
write.csv(locationData, "../Location-Data.csv", quote = FALSE, row.names = FALSE) #Save dataframe as .csv
```

```{r}
scatterpieData <- locationData[,c(8, 7, 6, 2, 4, 5, 3)] #Reorganize columns and subset data needed for pie chart
scatterpieData$region <- as.factor(scatterpieData$region) #Make sure everything region is a factor
scatterpieData$radius <- ((rowSums(x = scatterpieData[,4:7]))/3) #Scale pie radius based on number of observations for each region, and divide by 2 so pies are not too large
scatterpieData[which(between(scatterpieData$radius, 0, 5)),8] <- 5 #Replace any non-zero radius less than 5 with 5 so the radius shows up
head(scatterpieData) #Confirm subset
```

## Create color scheme

```{r}
pieColors <- RColorBrewer::brewer.pal(4, "RdBu") #Create a red-blue palette with 4 colors to represent positive, neutral, and negative effects of ocean acidification on reproductive processes
pieColors
```

## Create map plot

```{r}
#Create base plot to see what pies look like
ggplot() + geom_scatterpie(aes(x = longitude, y = latitude, group = region, r = radius), data = scatterpieData, cols = colnames(scatterpieData[,4:7]), alpha = 0.8) + coord_equal() + scale_fill_manual(values = pieColors[1:4])
```

```{r}
#pdf("Location-Data-Map-Plot.pdf", height = 4.25, width = 11)

world <- map_data('world') #Save worldwide map data

p <- ggplot(world, aes(long, lat)) + #Plot latitude and longitude of world data and save as an object
        geom_map(map=world, aes(map_id=region), fill= "lightgray", color="white") + #Separate regions. Land is grey and oceans are white
        coord_quickmap() + #Quick coordinate system
        theme(panel.background = element_rect(fill = "transparent"), #Remove grey background
              axis.title = element_blank(), #Remove axis labels
              axis.text = element_blank(), #Remove axis text
              axis.ticks = element_blank(), #Remove tick marks
              legend.key.size = unit(1.5, "line"), #Change legend size
              legend.text = element_text(size = 15)) #Change legend text size

p + #Plot the map object
        geom_scatterpie(aes(x = longitude, y = latitude, group = region, r = radius), data = scatterpieData, cols = colnames(scatterpieData[,4:7]), alpha = 0.8) + #Add pie charts on top with location data. Include legend labels
        scale_fill_manual(values = pieColors[1:4], name = "", ) #Specify legend and pie chart colors and legend title

#dev.off()
```

